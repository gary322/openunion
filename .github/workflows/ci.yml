name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: proofwork
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d proofwork"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/proofwork
      STORAGE_BACKEND: local
      STORAGE_LOCAL_DIR: ./var/uploads
      PUBLIC_BASE_URL: http://localhost:3000
      STRIPE_WEBHOOK_SECRET: whsec_test_secret
      BUYER_TOKEN_PEPPER: dev_pepper_change_me
      WORKER_TOKEN_PEPPER: dev_pepper_change_me
      SESSION_SECRET: dev_session_secret_change_me

    steps:
      - uses: actions/checkout@v4

      - name: CI guardrails (deploy env names)
        run: bash scripts/ci/check_deploy_workflow_envs.sh

      - name: Secret scan (tracked files)
        run: bash scripts/ci/secret_scan.sh

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Security audit (high)
        run: npm audit --audit-level=high

      - name: Unit/integration tests
        run: npm test

      - name: Typecheck/build (tsc)
        run: npm run build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: E2E tests
        run: npm run test:e2e

  s3_scan:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: proofwork
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d proofwork"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20
      clamav:
        image: clamav/clamav:stable
        ports:
          - 3310:3310

    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/proofwork
      BUYER_TOKEN_PEPPER: dev_pepper_change_me
      WORKER_TOKEN_PEPPER: dev_pepper_change_me
      SESSION_SECRET: dev_session_secret_change_me
      PUBLIC_BASE_URL: http://localhost:3000

      STORAGE_BACKEND: s3
      STORAGE_ENDPOINT: http://localhost:9000
      S3_REGION: us-east-1
      S3_ACCESS_KEY_ID: minioadmin
      S3_SECRET_ACCESS_KEY: minioadmin
      S3_BUCKET_STAGING: proofwork-staging
      S3_BUCKET_CLEAN: proofwork-clean
      S3_BUCKET_QUARANTINE: proofwork-quarantine

      SCANNER_ENGINE: clamd
      CLAMD_HOST: localhost
      CLAMD_PORT: 3310
      RUN_S3_SCAN_TESTS: "1"
      RUN_CLAMD_TESTS: "1"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Start MinIO (local S3)
        run: |
          set -euo pipefail
          docker run -d --name minio \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:latest server /data --console-address ":9001"
          for i in {1..60}; do
            if curl -fsS http://localhost:9000/minio/health/live >/dev/null; then
              echo "minio ok"
              break
            fi
            sleep 1
          done

      - name: Create MinIO buckets
        run: |
          set -euo pipefail
          docker run --rm --network host --entrypoint /bin/sh minio/mc:latest -c '
            mc alias set local http://localhost:9000 minioadmin minioadmin;
            mc mb -p local/proofwork-staging || true;
            mc mb -p local/proofwork-clean || true;
            mc mb -p local/proofwork-quarantine || true;
          '

      - name: Install dependencies
        run: npm ci

      - name: S3 + clamd scan tests
        run: npx vitest run tests/scanning_clamd.test.ts tests/s3_scan_pipeline.test.ts

  verifier_gateway:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: proofwork
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d proofwork"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 20

    env:
      DATABASE_URL: postgresql://postgres:postgres@127.0.0.1:5432/proofwork
      BUYER_TOKEN_PEPPER: dev_pepper_change_me
      WORKER_TOKEN_PEPPER: dev_pepper_change_me
      SESSION_SECRET: dev_session_secret_change_me
      RUN_PLAYWRIGHT_VERIFIER_TESTS: "1"

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright chromium
        run: npx playwright install --with-deps chromium

      - name: Verifier gateway (Playwright) tests
        run: npx vitest run tests/verifier_playwright_harness.test.ts
